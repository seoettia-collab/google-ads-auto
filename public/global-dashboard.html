<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Google Ads Auto ‚Äì Dashboard global</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* =========================
       RESET & VARIABLES
    ========================== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #020617;
      --bg-alt: #030711;
      --bg-card: rgba(15, 23, 42, 0.9);
      --bg-card-soft: rgba(17, 24, 39, 0.85);
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.18);
      --accent-strong: #6366f1;
      --accent-2: #0ea5e9;
      --danger: #f97373;
      --success: #22c55e;
      --warning: #facc15;
      --border: rgba(148, 163, 184, 0.3);
      --border-soft: rgba(31, 41, 55, 0.9);
      --text: #f9fafb;
      --muted: #9ca3af;
      --muted-soft: #6b7280;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.9);
      --radius-lg: 18px;
      --radius-md: 12px;
      --radius-sm: 999px;
      --font: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
              "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      font-family: var(--font);
      background:
        radial-gradient(circle at 0% -10%, rgba(56, 189, 248, 0.16), transparent 65%),
        radial-gradient(circle at 100% 110%, rgba(129, 140, 248, 0.20), transparent 60%),
        radial-gradient(circle at 50% 50%, rgba(15, 23, 42, 0.95), #020617);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    /* Scrollbars propres */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #020617;
    }
    ::-webkit-scrollbar-thumb {
      background: #111827;
      border-radius: 999px;
    }

    .page {
      max-width: 1220px;
      margin: 0 auto;
      padding: 22px 16px 40px;
    }

    /* =========================
       HEADER
    ========================== */
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(18px);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(2, 6, 23, 0.96));
      border-radius: 0 0 20px 20px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.15);
      margin: -22px -16px 20px;
      padding: 14px 18px 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 14px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.8);
    }

    .header-main {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    h1 {
      font-size: 1.35rem;
      font-weight: 600;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .brand-dot {
      width: 9px;
      height: 20px;
      border-radius: 999px;
      background: linear-gradient(180deg, var(--accent-2), var(--accent-strong));
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.6);
    }

    .subtitle {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: var(--radius-sm);
      padding: 5px 12px;
      font-size: 0.75rem;
      border: 1px solid var(--border);
      background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.18), rgba(15, 23, 42, 0.95));
      box-shadow: 0 8px 25px rgba(15, 23, 42, 0.7);
      white-space: nowrap;
    }

    .pill-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      box-shadow: 0 0 12px currentColor;
    }

    .dot-ok { color: var(--success); background: var(--success); }
    .dot-warn { color: var(--warning); background: var(--warning); }
    .dot-bad { color: var(--danger); background: var(--danger); }

    button {
      border-radius: var(--radius-sm);
      border: none;
      padding: 6px 14px;
      font-size: 0.8rem;
      cursor: pointer;
      background: radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.6), rgba(79, 70, 229, 0.92));
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow:
        0 12px 30px rgba(15, 23, 42, 0.95),
        0 0 24px rgba(56, 189, 248, 0.5);
      transition: transform 0.12s ease-out, box-shadow 0.12s ease-out,
                  filter 0.12s ease-out;
      white-space: nowrap;
    }

    button:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
      box-shadow:
        0 16px 40px rgba(15, 23, 42, 1),
        0 0 26px rgba(79, 70, 229, 0.6);
    }

    button:active {
      transform: translateY(0);
      box-shadow:
        0 8px 22px rgba(15, 23, 42, 0.9),
        0 0 16px rgba(79, 70, 229, 0.45);
    }

    button span.icon {
      font-size: 0.9rem;
    }

    /* =========================
       GRID M√âTRIQUES
    ========================== */
    .grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 14px;
      margin-bottom: 22px;
    }

    @media (max-width: 980px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .grid {
        grid-template-columns: 1fr;
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-right {
        width: 100%;
        justify-content: space-between;
      }
    }

    .card {
      position: relative;
      border-radius: var(--radius-lg);
      padding: 14px 16px 13px;
      background: radial-gradient(circle at 0 0, rgba(79, 70, 229, 0.16), rgba(15, 23, 42, 0.98));
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      isolation: isolate;
      backdrop-filter: blur(18px);
      transition: transform 0.14s ease-out, box-shadow 0.14s ease-out,
                  border-color 0.14s ease-out;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -60%;
      background:
        radial-gradient(circle at 0% 0%, rgba(56, 189, 248, 0.18), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(129, 140, 248, 0.18), transparent 55%);
      opacity: 0.8;
      z-index: -1;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow:
        0 24px 50px rgba(15, 23, 42, 0.95),
        0 0 22px rgba(56, 189, 248, 0.32);
      border-color: rgba(129, 140, 248, 0.9);
    }

    .card-title {
      font-size: 0.76rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted-soft);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .card-main {
      font-size: 1.45rem;
      font-weight: 600;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .card-main span.label {
      font-size: 0.86rem;
      color: var(--muted);
      font-weight: 400;
    }

    .card-sub {
      font-size: 0.82rem;
      color: var(--muted);
      margin-top: 6px;
      max-width: 90%;
    }

    .tag {
      border-radius: var(--radius-sm);
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 3px 9px;
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      white-space: nowrap;
    }

    .tag-blue {
      border-color: rgba(56, 189, 248, 0.9);
      color: #e0f2fe;
      background: linear-gradient(135deg, rgba(56,189,248,0.14), rgba(15,23,42,0.8));
    }

    .tag-green {
      border-color: rgba(34, 197, 94, 0.9);
      color: #dcfce7;
      background: linear-gradient(135deg, rgba(34,197,94,0.12), rgba(15,23,42,0.86));
    }

    .tag-amber {
      border-color: rgba(245, 158, 11, 0.9);
      color: #ffedd5;
      background: linear-gradient(135deg, rgba(245,158,11,0.14), rgba(15,23,42,0.85));
    }

    .timestamp {
      font-size: 0.74rem;
      color: var(--muted-soft);
      margin-top: 6px;
    }

    /* =========================
       SECTION JSON
    ========================== */
    .section-title {
      font-size: 0.86rem;
      margin: 10px 0 8px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.14em;
    }

    .json-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 980px) {
      .json-grid {
        grid-template-columns: 1fr;
      }
    }

    .json-card {
      background: radial-gradient(circle at 0 0, rgba(15, 23, 42, 0.98), #020617);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      padding: 9px 10px 10px;
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.9);
    }

    .json-title {
      font-size: 0.78rem;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .json-badge {
      font-size: 0.65rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      color: #e5e7eb;
    }

    pre {
      margin: 0;
      font-family: "SF Mono", Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 0.74rem;
      line-height: 1.4;
      max-height: 260px;
      overflow: auto;
      background: radial-gradient(circle at 0 0, #020617, #020617);
      color: #e5e7eb;
      border-radius: 8px;
      padding: 8px 9px;
      border: 1px solid #020617;
    }

    .error {
      font-size: 0.8rem;
      color: var(--danger);
      margin-top: 8px;
    }

    #global-error:empty {
      display: none;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="header-main">
        <h1>
          <span class="brand-dot"></span>
          <span>Google Ads Auto ‚Äì Dashboard global</span>
        </h1>
        <div class="subtitle">
          Vue synth√©tique : <strong>WF1</strong> (donn√©es) ¬∑ <strong>WF2</strong> (IA) ¬∑ <strong>WF3</strong> (actions & s√©curit√©).
        </div>
      </div>
      <div class="header-right">
        <div class="pill" id="backend-pill">
          <span class="pill-dot dot-warn" id="backend-dot"></span>
          <span id="backend-status-label">Backend : inconnu</span>
        </div>
        <button onclick="refreshAll()">
          <span class="icon">üîÑ</span>
          <span>Rafra√Æchir</span>
        </button>
      </div>
    </header>

    <!-- R√©sum√© global -->
    <div class="grid">
      <!-- WF1 -->
      <div class="card">
        <div class="card-title">
          <span>WF1 ‚Äì Donn√©es</span>
          <span class="tag tag-blue" id="wf1-status-tag">STATUT INCONNU</span>
        </div>
        <div class="card-main">
          <span id="wf1-budgets">0</span>
          <span class="label">alertes budget</span>
        </div>
        <div class="card-sub" id="wf1-sub">
          Aucun rapport WF1 trouv√©.
        </div>
        <div class="timestamp" id="wf1-ts"></div>
      </div>

      <!-- WF2 -->
      <div class="card">
        <div class="card-title">
          <span>WF2 ‚Äì IA (Claude + GPT)</span>
          <span class="tag tag-amber" id="wf2-status-tag">EN ATTENTE</span>
        </div>
        <div class="card-main">
          <span id="wf2-recos">0</span>
          <span class="label">recommandations</span>
        </div>
        <div class="card-sub" id="wf2-sub">
          Aucune recommandation re√ßue pour l'instant.
        </div>
        <div class="timestamp" id="wf2-ts"></div>
      </div>

      <!-- WF3 -->
      <div class="card">
        <div class="card-title">
          <span>WF3 ‚Äì Actions</span>
          <span class="tag tag-green" id="wf3-status-tag">MODE TEST</span>
        </div>
        <div class="card-main">
          <span id="wf3-actions">0</span>
          <span class="label">actions totales</span>
        </div>
        <div class="card-sub" id="wf3-sub">
          Aucune ex√©cution enregistr√©e.
        </div>
        <div class="timestamp" id="wf3-ts"></div>
      </div>

      <!-- S√©curit√© / limites -->
      <div class="card">
        <div class="card-title">
          <span>S√©curit√© & limites (WF3)</span>
          <span class="tag" id="sec-status-tag">NORMAL</span>
        </div>
        <div class="card-main">
          <span id="wf3-limits-used">0</span>
          <span class="label">actions / jour</span>
        </div>
        <div class="card-sub" id="sec-sub">
          Limites WF3 : chargement en cours‚Ä¶
        </div>
        <div class="timestamp" id="sec-ts"></div>
      </div>
    </div>

    <!-- JSON d√©taill√© -->
    <div class="section-title">D√©tail complet (JSON brut)</div>
    <div class="json-grid">
      <div class="json-card">
        <div class="json-title">
          <span>WF1 ‚Äì Dernier rapport</span>
          <span class="json-badge">DATA</span>
        </div>
        <pre id="json-wf1">{ "message": "En attente de chargement‚Ä¶" }</pre>
      </div>
      <div class="json-card">
        <div class="json-title">
          <span>WF2 ‚Äì Derni√®res recommandations</span>
          <span class="json-badge">IA</span>
        </div>
        <pre id="json-wf2">{ "message": "En attente de chargement‚Ä¶" }</pre>
      </div>
      <div class="json-card">
        <div class="json-title">
          <span>WF3 ‚Äì Derni√®re ex√©cution</span>
          <span class="json-badge">ACTIONS</span>
        </div>
        <pre id="json-wf3">{ "message": "En attente de chargement‚Ä¶" }</pre>
      </div>
    </div>

    <div class="error" id="global-error"></div>
  </div>

  <script>
    async function fetchJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      return res.json();
    }

    function safeString(v) {
      if (!v && v !== 0) return "‚Äî";
      return String(v);
    }

    function formatTs(ts) {
      if (!ts) return "";
      try {
        return "Derni√®re mise √† jour : " + new Date(ts).toLocaleString();
      } catch {
        return "";
      }
    }

    async function refreshAll() {
      document.getElementById("global-error").textContent = "";

      // Backend health
      try {
        const health = await fetchJson("/health");
        const backendDot = document.getElementById("backend-dot");
        const backendLabel = document.getElementById("backend-status-label");
        if (health && health.status === "ok") {
          backendDot.classList.remove("dot-warn","dot-bad");
          backendDot.classList.add("dot-ok");
          backendLabel.textContent = "Backend : op√©rationnel (" + (health.version || "v?") + ")";
        } else {
          backendDot.classList.remove("dot-ok");
          backendDot.classList.add("dot-warn");
          backendLabel.textContent = "Backend : r√©ponse inattendue";
        }
      } catch (e) {
        const backendDot = document.getElementById("backend-dot");
        backendDot.classList.remove("dot-ok","dot-warn");
        backendDot.classList.add("dot-bad");
        document.getElementById("backend-status-label").textContent = "Backend : erreur";
      }

      // WF1
      try {
        const wf1 = await fetchJson("/api/wf1/last-report");
        document.getElementById("json-wf1").textContent = JSON.stringify(wf1, null, 2);

        const report = wf1.report || {};
        const data = report.data || {};

        const budgets = (data.budget_warnings || []).length || 0;
        const negs = (data.add_negative_keywords || []).length || 0;
        const bids = (data.adjust_bids || []).length || 0;
        const issues = (data.landing_page_issues || []).length || 0;

        document.getElementById("wf1-budgets").textContent = budgets;
        document.getElementById("wf1-sub").textContent =
          negs + " mots-cl√©s n√©gatifs ¬∑ " +
          bids + " ajustements d'ench√®res ¬∑ " +
          issues + " probl√®mes de landing";

        document.getElementById("wf1-status-tag").textContent =
          (data.status || "INCONNU").toUpperCase();
        document.getElementById("wf1-ts").textContent =
          formatTs(report.timestamp || wf1.timestamp || null);
      } catch (e) {
        document.getElementById("wf1-sub").textContent = "Impossible de charger WF1.";
      }

      // WF2
      try {
        const wf2 = await fetchJson("/api/wf2/last-recommendations");
        document.getElementById("json-wf2").textContent = JSON.stringify(wf2, null, 2);

        const recos = wf2.recommendations || (wf2.data && wf2.data.recommendations) || [];
        const count = recos.length || 0;

        document.getElementById("wf2-recos").textContent = count;
        document.getElementById("wf2-sub").textContent =
          count > 0
            ? "Recommandations pr√™tes pour WF3."
            : "Aucune recommandation active.";

        document.getElementById("wf2-status-tag").textContent =
          (wf2.status || "ANALYSE").toUpperCase();
        document.getElementById("wf2-ts").textContent =
          formatTs(wf2.analysis_date || wf2.timestamp || wf2.last_run_at);
      } catch (e) {
        document.getElementById("wf2-sub").textContent = "Impossible de charger WF2.";
      }

      // WF3 last execution
      try {
        const wf3 = await fetchJson("/api/wf3/last-execution");
        document.getElementById("json-wf3").textContent = JSON.stringify(wf3, null, 2);

        const exec = wf3.execution || wf3.data || {};
        const stats = exec.stats || {};
        const total = stats.total_actions || stats.actions_total || 0;

        document.getElementById("wf3-actions").textContent = total;
        document.getElementById("wf3-sub").textContent =
          total > 0
            ? (stats.executed || stats.actions_executed || 0) + " ex√©cut√©es ¬∑ " +
              (stats.blocked || stats.actions_blocked || 0) + " bloqu√©es"
            : "Aucune ex√©cution enregistr√©e.";

        document.getElementById("wf3-status-tag").textContent =
          (exec.mode || "TEST").toUpperCase();
        document.getElementById("wf3-ts").textContent =
          formatTs(exec.timestamp || wf3.timestamp || wf3.last_run_at);

        // Limites / s√©curit√©
        const used =
          (stats.executed || 0) +
          (stats.blocked || 0);
        document.getElementById("wf3-limits-used").textContent = used;
        document.getElementById("sec-sub").textContent =
          "Derni√®re ex√©cution : " + safeString(exec.mode || "TEST");
        document.getElementById("sec-ts").textContent =
          formatTs(exec.timestamp || wf3.timestamp || null);
      } catch (e) {
        document.getElementById("wf3-sub").textContent = "Impossible de charger WF3.";
        document.getElementById("sec-sub").textContent = "Erreur chargement WF3.";
      }
    }

    // Chargement automatique
    refreshAll();
  </script>
</body>
</html>
